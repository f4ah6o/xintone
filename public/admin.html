<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç®¡ç†è€…ç”»é¢ - xintone</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    .tab-container {
      display: flex;
      gap: 10px;
      margin-bottom: 20px;
      border-bottom: 2px solid var(--border-color);
    }

    .tab {
      padding: 10px 20px;
      background: none;
      border: none;
      cursor: pointer;
      font-size: 16px;
      color: var(--text-muted);
      border-bottom: 3px solid transparent;
      transition: all 0.2s;
    }

    .tab:hover {
      color: var(--text-color);
    }

    .tab.active {
      color: var(--primary-color);
      border-bottom-color: var(--primary-color);
      font-weight: 600;
    }

    .tab-content {
      display: none;
    }

    .tab-content.active {
      display: block;
    }

    .app-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: var(--white);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin-bottom: 10px;
    }

    .app-list-item:hover {
      background: var(--light-bg);
    }

    .user-list-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 15px;
      background: var(--white);
      border: 1px solid var(--border-color);
      border-radius: 6px;
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <div class="header-content">
      <h1>xintone - ç®¡ç†è€…ç”»é¢</h1>
      <div class="header-nav">
        <a href="/apps.html" class="btn btn-sm btn-secondary">â† ã‚¢ãƒ—ãƒªä¸€è¦§</a>
        <div class="user-info">
          <span class="user-email" id="user-email"></span>
          <span class="admin-badge">ç®¡ç†è€…</span>
          <button class="btn btn-sm btn-secondary" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- ã‚¿ãƒ– -->
    <div class="tab-container">
      <button class="tab active" onclick="switchTab('apps')">ã‚¢ãƒ—ãƒªç®¡ç†</button>
      <button class="tab" onclick="switchTab('users')">ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†</button>
    </div>

    <!-- ã‚¢ãƒ—ãƒªç®¡ç†ã‚¿ãƒ– -->
    <div id="apps-tab" class="tab-content active">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ã‚¢ãƒ—ãƒªä¸€è¦§</h2>
          <div class="flex-gap">
            <button class="btn btn-success btn-sm" onclick="showAppModal()">
              â• ã‚¢ãƒ—ãƒªè¿½åŠ 
            </button>
            <button class="btn btn-primary btn-sm" onclick="loadApps()">
              ğŸ”„ æ›´æ–°
            </button>
          </div>
        </div>

        <div id="apps-container">
          <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
    </div>

    <!-- ãƒ¦ãƒ¼ã‚¶ãƒ¼ç®¡ç†ã‚¿ãƒ– -->
    <div id="users-tab" class="tab-content">
      <div class="card">
        <div class="card-header">
          <h2 class="card-title">ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§</h2>
          <button class="btn btn-primary btn-sm" onclick="loadUsers()">
            ğŸ”„ æ›´æ–°
          </button>
        </div>

        <div id="users-container">
          <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
        </div>
      </div>
    </div>
  </div>

  <!-- ã‚¢ãƒ—ãƒªç·¨é›†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="app-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title" id="app-modal-title">ã‚¢ãƒ—ãƒªè¿½åŠ </h3>
        <button class="modal-close" onclick="closeAppModal()">âœ•</button>
      </div>
      <form id="app-form" onsubmit="saveApp(event)">
        <div class="form-group">
          <label class="form-label">ã‚¢ãƒ—ãƒªå *</label>
          <input type="text" id="app-name" class="form-control" required>
        </div>

        <div class="form-group">
          <label class="form-label">èª¬æ˜</label>
          <textarea id="app-description" class="form-control"></textarea>
        </div>

        <div class="form-group">
          <label class="form-label">kintone ãƒ‰ãƒ¡ã‚¤ãƒ³ *</label>
          <input type="text" id="app-domain" class="form-control" placeholder="your-domain.cybozu.com" required>
        </div>

        <div class="form-group">
          <label class="form-label">kintone ã‚¢ãƒ—ãƒª ID *</label>
          <input type="text" id="app-kintone-id" class="form-control" placeholder="1" required>
        </div>

        <div class="form-group">
          <label class="form-label">ã‚¢ã‚¤ã‚³ãƒ³ (çµµæ–‡å­—)</label>
          <input type="text" id="app-icon" class="form-control" placeholder="ğŸ“‹" maxlength="2">
        </div>

        <div class="form-group">
          <label class="form-check">
            <input type="checkbox" id="app-active" checked>
            ã‚¢ã‚¯ãƒ†ã‚£ãƒ–
          </label>
        </div>

        <div class="flex-gap">
          <button type="submit" class="btn btn-primary">ä¿å­˜</button>
          <button type="button" class="btn btn-secondary" onclick="closeAppModal()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        </div>
      </form>
    </div>
  </div>

  <!-- ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç®¡ç†ãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div id="access-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h3 class="modal-title">ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç®¡ç†</h3>
        <button class="modal-close" onclick="closeAccessModal()">âœ•</button>
      </div>
      <div id="access-modal-body">
        <!-- æ¨©é™ç®¡ç†UIãŒã“ã“ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
      </div>
    </div>
  </div>

  <script src="/common.js"></script>
  <script>
    let apps = [];
    let users = [];
    let currentEditingAppId = null;

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', async () => {
      initSupabase();

      // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
      const session = await checkSession();
      if (!session) {
        window.location.href = '/';
        return;
      }

      // ç®¡ç†è€…ãƒã‚§ãƒƒã‚¯
      if (!isAdmin()) {
        alert('ç®¡ç†è€…æ¨©é™ãŒå¿…è¦ã§ã™');
        window.location.href = '/apps.html';
        return;
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
      document.getElementById('user-email').textContent = currentUser.email;

      // ã‚¢ãƒ—ãƒªä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
      await loadApps();
    });

    // ã‚¿ãƒ–åˆ‡ã‚Šæ›¿ãˆ
    function switchTab(tabName) {
      // ã™ã¹ã¦ã®ã‚¿ãƒ–ã‚’éã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));

      // é¸æŠã—ãŸã‚¿ãƒ–ã‚’ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã«
      event.target.classList.add('active');
      document.getElementById(tabName + '-tab').classList.add('active');

      // ã‚¿ãƒ–ã«å¿œã˜ã¦ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã‚€
      if (tabName === 'users' && users.length === 0) {
        loadUsers();
      }
    }

    // ã‚¢ãƒ—ãƒªä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    async function loadApps() {
      try {
        showLoading('apps-container');

        const { data, error } = await supabaseClient
          .from('kintone_apps')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        apps = data || [];
        renderApps();
      } catch (error) {
        console.error('Error loading apps:', error);
        showError('apps-container', 'ã‚¢ãƒ—ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ã‚¢ãƒ—ãƒªä¸€è¦§ã‚’è¡¨ç¤º
    function renderApps() {
      const container = document.getElementById('apps-container');

      if (apps.length === 0) {
        container.innerHTML = `
          <div class="text-center text-muted" style="padding: 40px;">
            <p>ã‚¢ãƒ—ãƒªãŒã‚ã‚Šã¾ã›ã‚“</p>
          </div>
        `;
        return;
      }

      const html = apps.map(app => `
        <div class="app-list-item">
          <div style="flex: 1;">
            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
              <span style="font-size: 24px;">${app.icon || 'ğŸ“‹'}</span>
              <h3 style="margin: 0;">${app.name}</h3>
              ${app.is_active ? '<span class="badge badge-success">ã‚¢ã‚¯ãƒ†ã‚£ãƒ–</span>' : '<span class="badge badge-danger">éã‚¢ã‚¯ãƒ†ã‚£ãƒ–</span>'}
            </div>
            <p class="text-muted" style="margin: 5px 0;">${app.description || ''}</p>
            <div style="display: flex; gap: 15px; font-size: 12px; color: var(--text-muted);">
              <span>ãƒ‰ãƒ¡ã‚¤ãƒ³: ${app.kintone_domain}</span>
              <span>App ID: ${app.kintone_app_id}</span>
              <span>ä½œæˆæ—¥: ${formatDate(app.created_at)}</span>
            </div>
          </div>
          <div class="flex-gap">
            <button class="btn btn-sm btn-primary" onclick="manageAccess('${app.id}')">
              ğŸ‘¥ æ¨©é™ç®¡ç†
            </button>
            <button class="btn btn-sm btn-secondary" onclick="editApp('${app.id}')">
              ç·¨é›†
            </button>
            <button class="btn btn-sm btn-danger" onclick="deleteApp('${app.id}')">
              å‰Šé™¤
            </button>
          </div>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    // ã‚¢ãƒ—ãƒªãƒ¢ãƒ¼ãƒ€ãƒ«è¡¨ç¤º
    function showAppModal(appId = null) {
      currentEditingAppId = appId;

      if (appId) {
        // ç·¨é›†ãƒ¢ãƒ¼ãƒ‰
        const app = apps.find(a => a.id === appId);
        if (!app) return;

        document.getElementById('app-modal-title').textContent = 'ã‚¢ãƒ—ãƒªç·¨é›†';
        document.getElementById('app-name').value = app.name;
        document.getElementById('app-description').value = app.description || '';
        document.getElementById('app-domain').value = app.kintone_domain;
        document.getElementById('app-kintone-id').value = app.kintone_app_id;
        document.getElementById('app-icon').value = app.icon || '';
        document.getElementById('app-active').checked = app.is_active;
      } else {
        // æ–°è¦ä½œæˆãƒ¢ãƒ¼ãƒ‰
        document.getElementById('app-modal-title').textContent = 'ã‚¢ãƒ—ãƒªè¿½åŠ ';
        document.getElementById('app-form').reset();
        document.getElementById('app-active').checked = true;
      }

      document.getElementById('app-modal').classList.add('active');
    }

    // ã‚¢ãƒ—ãƒªãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeAppModal() {
      document.getElementById('app-modal').classList.remove('active');
      currentEditingAppId = null;
    }

    // ã‚¢ãƒ—ãƒªç·¨é›†
    function editApp(appId) {
      showAppModal(appId);
    }

    // ã‚¢ãƒ—ãƒªä¿å­˜
    async function saveApp(event) {
      event.preventDefault();

      const appData = {
        name: document.getElementById('app-name').value,
        description: document.getElementById('app-description').value,
        kintone_domain: document.getElementById('app-domain').value,
        kintone_app_id: document.getElementById('app-kintone-id').value,
        icon: document.getElementById('app-icon').value,
        is_active: document.getElementById('app-active').checked,
      };

      try {
        if (currentEditingAppId) {
          // æ›´æ–°
          const { error } = await supabaseClient
            .from('kintone_apps')
            .update(appData)
            .eq('id', currentEditingAppId);

          if (error) throw error;
          alert('ã‚¢ãƒ—ãƒªã‚’æ›´æ–°ã—ã¾ã—ãŸ');
        } else {
          // æ–°è¦ä½œæˆ
          appData.created_by = currentUser.id;

          const { error } = await supabaseClient
            .from('kintone_apps')
            .insert([appData]);

          if (error) throw error;
          alert('ã‚¢ãƒ—ãƒªã‚’è¿½åŠ ã—ã¾ã—ãŸ');
        }

        closeAppModal();
        await loadApps();
      } catch (error) {
        console.error('Error saving app:', error);
        alert('ä¿å­˜ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ã‚¢ãƒ—ãƒªå‰Šé™¤
    async function deleteApp(appId) {
      if (!confirm('ã“ã®ã‚¢ãƒ—ãƒªã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿé–¢é€£ã™ã‚‹æ¨©é™è¨­å®šã‚‚ã™ã¹ã¦å‰Šé™¤ã•ã‚Œã¾ã™ã€‚')) {
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('kintone_apps')
          .delete()
          .eq('id', appId);

        if (error) throw error;

        alert('ã‚¢ãƒ—ãƒªã‚’å‰Šé™¤ã—ã¾ã—ãŸ');
        await loadApps();
      } catch (error) {
        console.error('Error deleting app:', error);
        alert('å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ç®¡ç†
    async function manageAccess(appId) {
      const app = apps.find(a => a.id === appId);
      if (!app) return;

      try {
        // ã™ã¹ã¦ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’å–å¾—
        const { data: profilesData, error: profilesError } = await supabaseClient
          .from('profiles')
          .select('*')
          .order('created_at', { ascending: false });

        if (profilesError) throw profilesError;

        // ã“ã®ã‚¢ãƒ—ãƒªã®æ¨©é™è¨­å®šã‚’å–å¾—
        const { data: accessData, error: accessError } = await supabaseClient
          .from('user_app_access')
          .select('*')
          .eq('app_id', appId);

        if (accessError) throw accessError;

        // ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãƒãƒƒãƒ—ã‚’ä½œæˆ
        const accessMap = {};
        accessData.forEach(access => {
          accessMap[access.user_id] = access;
        });

        // UIã‚’ç”Ÿæˆ
        const html = `
          <h4 style="margin-bottom: 20px;">${app.name} ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™</h4>
          <div style="max-height: 60vh; overflow-y: auto;">
            ${profilesData.map(profile => {
              const access = accessMap[profile.id];
              const hasAccess = !!access;

              return `
                <div class="user-list-item">
                  <div>
                    <div>${profile.email}</div>
                    <div class="text-muted" style="font-size: 12px;">
                      ${profile.role === 'admin' ? 'ç®¡ç†è€…' : 'ãƒ¦ãƒ¼ã‚¶ãƒ¼'}
                    </div>
                  </div>
                  <div>
                    ${hasAccess ? `
                      <div class="flex-gap" style="margin-bottom: 10px;">
                        <label class="form-check">
                          <input type="checkbox" ${access.can_read ? 'checked' : ''}
                            onchange="updateAccess('${appId}', '${profile.id}', 'can_read', this.checked)">
                          å‚ç…§
                        </label>
                        <label class="form-check">
                          <input type="checkbox" ${access.can_write ? 'checked' : ''}
                            onchange="updateAccess('${appId}', '${profile.id}', 'can_write', this.checked)">
                          ç·¨é›†
                        </label>
                        <label class="form-check">
                          <input type="checkbox" ${access.can_delete ? 'checked' : ''}
                            onchange="updateAccess('${appId}', '${profile.id}', 'can_delete', this.checked)">
                          å‰Šé™¤
                        </label>
                      </div>
                      <div class="form-group" style="margin-bottom: 10px;">
                        <input type="text" class="form-control" placeholder="kintone API ãƒˆãƒ¼ã‚¯ãƒ³"
                          value="${access.api_token || ''}"
                          onchange="updateApiToken('${appId}', '${profile.id}', this.value)">
                      </div>
                      <button class="btn btn-sm btn-danger" onclick="revokeAccess('${appId}', '${profile.id}')">
                        ã‚¢ã‚¯ã‚»ã‚¹å‰Šé™¤
                      </button>
                    ` : `
                      <button class="btn btn-sm btn-success" onclick="grantAccess('${appId}', '${profile.id}')">
                        ã‚¢ã‚¯ã‚»ã‚¹è¨±å¯
                      </button>
                    `}
                  </div>
                </div>
              `;
            }).join('')}
          </div>
          <div class="mt-2">
            <button class="btn btn-secondary" onclick="closeAccessModal()">é–‰ã˜ã‚‹</button>
          </div>
        `;

        document.getElementById('access-modal-body').innerHTML = html;
        document.getElementById('access-modal').classList.add('active');
      } catch (error) {
        console.error('Error loading access:', error);
        alert('ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ä»˜ä¸
    async function grantAccess(appId, userId) {
      try {
        const { error } = await supabaseClient
          .from('user_app_access')
          .insert([{
            user_id: userId,
            app_id: appId,
            api_token: '',
            can_read: true,
            can_write: false,
            can_delete: false,
          }]);

        if (error) throw error;

        await manageAccess(appId);
      } catch (error) {
        console.error('Error granting access:', error);
        alert('æ¨©é™ã®ä»˜ä¸ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’å‰Šé™¤
    async function revokeAccess(appId, userId) {
      if (!confirm('ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('user_app_access')
          .delete()
          .eq('app_id', appId)
          .eq('user_id', userId);

        if (error) throw error;

        await manageAccess(appId);
      } catch (error) {
        console.error('Error revoking access:', error);
        alert('æ¨©é™ã®å‰Šé™¤ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’æ›´æ–°
    async function updateAccess(appId, userId, permission, value) {
      try {
        const updateData = {};
        updateData[permission] = value;

        const { error } = await supabaseClient
          .from('user_app_access')
          .update(updateData)
          .eq('app_id', appId)
          .eq('user_id', userId);

        if (error) throw error;
      } catch (error) {
        console.error('Error updating access:', error);
        alert('æ¨©é™ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’æ›´æ–°
    async function updateApiToken(appId, userId, token) {
      try {
        const { error } = await supabaseClient
          .from('user_app_access')
          .update({ api_token: token })
          .eq('app_id', appId)
          .eq('user_id', userId);

        if (error) throw error;
      } catch (error) {
        console.error('Error updating token:', error);
        alert('ãƒˆãƒ¼ã‚¯ãƒ³ã®æ›´æ–°ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeAccessModal() {
      document.getElementById('access-modal').classList.remove('active');
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    async function loadUsers() {
      try {
        showLoading('users-container');

        const { data, error } = await supabaseClient
          .from('profiles')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        users = data || [];
        renderUsers();
      } catch (error) {
        console.error('Error loading users:', error);
        showError('users-container', 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ä¸€è¦§ã‚’è¡¨ç¤º
    function renderUsers() {
      const container = document.getElementById('users-container');

      if (users.length === 0) {
        container.innerHTML = `
          <div class="text-center text-muted" style="padding: 40px;">
            <p>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã„ã¾ã›ã‚“</p>
          </div>
        `;
        return;
      }

      const html = users.map(user => `
        <div class="user-list-item">
          <div>
            <div style="font-weight: 600;">${user.email}</div>
            <div class="text-muted" style="font-size: 12px;">
              ç™»éŒ²æ—¥: ${formatDate(user.created_at)}
            </div>
          </div>
          <div class="flex-gap">
            ${user.role === 'admin' ?
              '<span class="badge badge-warning">ç®¡ç†è€…</span>' :
              '<span class="badge badge-success">ãƒ¦ãƒ¼ã‚¶ãƒ¼</span>'
            }
            ${user.id !== currentUser.id ? `
              <button class="btn btn-sm btn-secondary" onclick="toggleUserRole('${user.id}', '${user.role}')">
                ${user.role === 'admin' ? 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«å¤‰æ›´' : 'ç®¡ç†è€…ã«å¤‰æ›´'}
              </button>
            ` : '<span class="text-muted" style="font-size: 12px;">(è‡ªåˆ†)</span>'}
          </div>
        </div>
      `).join('');

      container.innerHTML = html;
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«ã‚’åˆ‡ã‚Šæ›¿ãˆ
    async function toggleUserRole(userId, currentRole) {
      const newRole = currentRole === 'admin' ? 'user' : 'admin';

      if (!confirm(`ã“ã®ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚’${newRole === 'admin' ? 'ç®¡ç†è€…' : 'ä¸€èˆ¬ãƒ¦ãƒ¼ã‚¶ãƒ¼'}ã«å¤‰æ›´ã—ã¾ã™ã‹ï¼Ÿ`)) {
        return;
      }

      try {
        const { error } = await supabaseClient
          .from('profiles')
          .update({ role: newRole })
          .eq('id', userId);

        if (error) throw error;

        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ­ãƒ¼ãƒ«ã‚’å¤‰æ›´ã—ã¾ã—ãŸ');
        await loadUsers();
      } catch (error) {
        console.error('Error updating role:', error);
        alert('ãƒ­ãƒ¼ãƒ«ã®å¤‰æ›´ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
    document.getElementById('app-modal').addEventListener('click', (e) => {
      if (e.target.id === 'app-modal') {
        closeAppModal();
      }
    });

    document.getElementById('access-modal').addEventListener('click', (e) => {
      if (e.target.id === 'access-modal') {
        closeAccessModal();
      }
    });
  </script>
</body>
</html>
