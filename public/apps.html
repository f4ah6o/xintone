<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ã‚¢ãƒ—ãƒªä¸€è¦§ - xintone</title>
  <link rel="stylesheet" href="/styles.css">
  <script src="https://unpkg.com/htmx.org@1.9.12"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
  <div class="header">
    <div class="header-content">
      <h1>xintone</h1>
      <div class="header-nav">
        <div class="user-info" id="user-info">
          <span class="user-email" id="user-email"></span>
          <span id="admin-badge" style="display: none;" class="admin-badge">ç®¡ç†è€…</span>
          <button class="btn btn-sm btn-secondary" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
        </div>
      </div>
    </div>
  </div>

  <div class="container">
    <!-- ç®¡ç†è€…ãƒªãƒ³ã‚¯ -->
    <div id="admin-link" style="display: none;" class="mb-2">
      <a href="/admin.html" class="btn btn-warning">ç®¡ç†è€…ç”»é¢</a>
    </div>

    <!-- ã‚¢ãƒ—ãƒªä¸€è¦§ -->
    <div class="card">
      <div class="card-header">
        <h2 class="card-title">ã‚¢ãƒ—ãƒªä¸€è¦§</h2>
        <button class="btn btn-primary btn-sm" onclick="loadApps()">
          æ›´æ–°
        </button>
      </div>

      <div id="apps-container">
        <div class="loading">èª­ã¿è¾¼ã¿ä¸­...</div>
      </div>
    </div>
  </div>

  <script src="/common.js"></script>
  <script>
    let userApps = [];

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®åˆæœŸåŒ–
    window.addEventListener('DOMContentLoaded', async () => {
      initSupabase();

      // ãƒ­ã‚°ã‚¤ãƒ³ãƒã‚§ãƒƒã‚¯
      const session = await checkSession();
      if (!session) {
        window.location.href = '/';
        return;
      }

      // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
      displayUserInfo();

      // ã‚¢ãƒ—ãƒªä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
      await loadApps();
    });

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼æƒ…å ±è¡¨ç¤º
    function displayUserInfo() {
      if (currentUser) {
        document.getElementById('user-email').textContent = currentUser.email;

        if (isAdmin()) {
          document.getElementById('admin-badge').style.display = 'inline-block';
          document.getElementById('admin-link').style.display = 'block';
        }
      }
    }

    // ã‚¢ãƒ—ãƒªä¸€è¦§ã‚’èª­ã¿è¾¼ã‚€
    async function loadApps() {
      try {
        showLoading('apps-container');

        if (!supabaseClient) {
          throw new Error('Supabase ãŒåˆæœŸåŒ–ã•ã‚Œã¦ã„ã¾ã›ã‚“');
        }

        // ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚¢ãƒ—ãƒªã‚’å–å¾—
        const { data: accessData, error: accessError } = await supabaseClient
          .from('user_app_access')
          .select(`
            *,
            kintone_apps (*)
          `)
          .eq('user_id', currentUser.id);

        if (accessError) throw accessError;

        userApps = accessData || [];

        if (userApps.length === 0) {
          document.getElementById('apps-container').innerHTML = `
            <div class="text-center text-muted" style="padding: 40px;">
              <p>ã‚¢ã‚¯ã‚»ã‚¹ã§ãã‚‹ã‚¢ãƒ—ãƒªãŒã‚ã‚Šã¾ã›ã‚“</p>
              <p style="margin-top: 10px; font-size: 14px;">ç®¡ç†è€…ã«ã‚¢ã‚¯ã‚»ã‚¹æ¨©é™ã‚’ä¾é ¼ã—ã¦ãã ã•ã„</p>
            </div>
          `;
          return;
        }

        // ã‚¢ãƒ—ãƒªã‚«ãƒ¼ãƒ‰è¡¨ç¤º
        renderApps();
      } catch (error) {
        console.error('Error loading apps:', error);
        showError('apps-container', 'ã‚¢ãƒ—ãƒªã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ: ' + error.message);
      }
    }

    // ã‚¢ãƒ—ãƒªã‚«ãƒ¼ãƒ‰ã‚’è¡¨ç¤º
    function renderApps() {
      const container = document.getElementById('apps-container');

      const html = `
        <div class="grid grid-3">
          ${userApps.map(access => {
            const app = access.kintone_apps;
            const permissions = [];
            if (access.can_read) permissions.push('å‚ç…§');
            if (access.can_write) permissions.push('ç·¨é›†');
            if (access.can_delete) permissions.push('å‰Šé™¤');

            return `
              <div class="app-card" onclick="openApp('${app.id}', '${access.api_token}')">
                <div class="app-card-header">
                  <div class="app-icon">${app.icon || 'ğŸ“‹'}</div>
                  <div class="app-info">
                    <h3>${app.name}</h3>
                    <p>${app.description || ''}</p>
                  </div>
                </div>
                <div class="app-meta">
                  <span>ğŸ”‘ ${permissions.join(', ')}</span>
                </div>
                <div class="app-meta">
                  <span>ğŸ“± App ID: ${app.kintone_app_id}</span>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;

      container.innerHTML = html;
    }

    // ã‚¢ãƒ—ãƒªã‚’é–‹ã
    function openApp(appId, apiToken) {
      // ã‚¢ãƒ—ãƒªIDã¨APIãƒˆãƒ¼ã‚¯ãƒ³ã‚’ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã«ä¿å­˜
      sessionStorage.setItem('currentAppId', appId);
      sessionStorage.setItem('currentApiToken', apiToken);

      // ãƒ¬ã‚³ãƒ¼ãƒ‰ä¸€è¦§ãƒšãƒ¼ã‚¸ã¸é·ç§»
      window.location.href = '/records.html';
    }
  </script>
</body>
</html>
